import{f as p,a as v,c as fe}from"../chunks/DwaBocJP.js";import{i as je}from"../chunks/Cn36vQlI.js";import{o as Oe}from"../chunks/CbLRd9uU.js";import{z as We,A as T,B as Ge,D as l,C as d,F as o,b as e,m as Q,c as m,G as te,E as he}from"../chunks/D8pH6ZKL.js";import{e as w,s as A}from"../chunks/DMOeGUlm.js";import{i as k}from"../chunks/BXZ4KMWb.js";import{s as z,e as be,i as ge}from"../chunks/CaL8-jqQ.js";import{s as ye}from"../chunks/CeRkQ_jF.js";import{i as Ve,s as Je}from"../chunks/CMTjv1Cc.js";import{a as P}from"../chunks/D_yn4hlI.js";import{t as h}from"../chunks/DEEbTplX.js";import{b as we}from"../chunks/DZFsq0ZI.js";var Xe=p("<strong>Warning:</strong> Devices scanning this code will be <u>immediately authorized</u>. Valid for 24 hours.",1),Ye=p("Devices scanning this code will appear as <strong>Pending</strong> below.",1),Ze=p('<div><h3> </h3> <img alt="Pairing QR" class="svelte-ecn2p3"/> <p class="hint svelte-ecn2p3"><!></p> <button class="btn-text svelte-ecn2p3">Close</button></div>'),et=p('<div class="loading svelte-ecn2p3">Loading devices...</div>'),tt=p('<div class="empty svelte-ecn2p3">No devices registered. Scan a QR code to add one.</div>'),at=p('<span class="badge deleted svelte-ecn2p3">Deleted</span>'),st=p("<span> </span>"),rt=p("<option> </option>"),nt=p('<button class="btn-icon restore svelte-ecn2p3" title="Restore">‚ôªÔ∏è</button>'),ot=p('<button class="btn-icon approve svelte-ecn2p3" title="Approve">‚úÖ</button>'),lt=p('<button class="btn-icon block svelte-ecn2p3" title="Block">‚õî</button>'),it=p('<!> <!> <button class="btn-icon delete svelte-ecn2p3" title="Delete">üóëÔ∏è</button>',1),ct=p('<tr><td class="svelte-ecn2p3"><!></td><td class="svelte-ecn2p3"><div class="device-name"> </div></td><td class="svelte-ecn2p3"><div class="mono-id svelte-ecn2p3"> </div> <div class="mono-key svelte-ecn2p3" title="Public Key"> </div></td><td class="svelte-ecn2p3"><div class="home-node-control svelte-ecn2p3"><select class="svelte-ecn2p3"><option> </option><!></select></div></td><td class="svelte-ecn2p3"> </td><td class="actions svelte-ecn2p3"><!></td></tr>'),dt=p('<table class="svelte-ecn2p3"><thead><tr><th class="svelte-ecn2p3">Status</th><th class="svelte-ecn2p3">Device Name</th><th class="svelte-ecn2p3">ID / Key</th><th class="svelte-ecn2p3">Home Node (Proxy Target)</th><th class="svelte-ecn2p3">Last Seen</th><th class="svelte-ecn2p3">Actions</th></tr></thead><tbody></tbody></table>'),vt=p('<div class="page"><header class="svelte-ecn2p3"><h1 class="svelte-ecn2p3">Device Management</h1> <div class="action-group svelte-ecn2p3"><button>Show Standard QR</button> <button>Show Auto-Approve QR</button> <button class="btn secondary svelte-ecn2p3">‚Üª Refresh</button></div></header> <!> <div class="device-list"><!></div></div>');function It(ke,De){We(De,!1);let E=Q([]),L=Q([]),$=Q(!0),j=Q(""),x=Q(!1),R=Q("standard");async function B(){m($,!0);try{const[t,n,s]=await Promise.all([P.get("/api/admin/devices?include_deleted=true"),P.get("/mesh/nodes"),P.get("/mesh/status")]);if(m(E,t||[]),m(L,n||[]),s&&s.instance_id){const u={instance_id:s.instance_id,role:s.role||"peer",base_url:s.base_url||"http://localhost:3210",is_self:!0};m(L,[u,...e(L)])}}catch(t){h.add("Failed to load data: "+t.message,"error")}finally{m($,!1)}}async function ae(t,n){try{await P.put(`/api/admin/devices/${t}/status`,{status:n}),h.add(`Device ${n}`,"success"),m(E,e(E).map(s=>s.deviceId===t?{...s,status:n}:s))}catch(s){h.add(s.message,"error")}}async function Ie(t,n){try{await P.put(`/api/admin/devices/${t}/home`,{homeInstanceId:n}),h.add("Home Node updated","success")}catch(s){h.add(s.message,"error")}}async function Ae(t){if(confirm("Are you sure you want to delete this device? This will sync to all nodes."))try{await P.delete(`/api/admin/devices/${t}`),h.add("Device deleted","success"),await B()}catch(n){h.add(n.message,"error")}}async function xe(t){try{await P.post(`/api/admin/devices/${t}/restore`),h.add("Device restored","success"),await B()}catch(n){h.add(n.message,"error")}}async function se(t="standard"){if(e(x)&&e(R)===t){m(x,!1);return}m(R,t);try{const n=localStorage.getItem("auth_token"),s=t==="vip"?`${we}/api/internal/pairing-qr?type=vip`:`${we}/api/internal/pairing-qr`,f=await(await fetch(s,{headers:{Authorization:`Bearer ${n}`}})).blob();m(j,URL.createObjectURL(f)),m(x,!0)}catch{h.add("Failed to load Pairing QR","error")}}function re(t,n=!1){if(!t)return"Unknown";const s=e(L).find(r=>r.instance_id===t);let u="UNKNOWN";s?u=s.role.toUpperCase():t.includes("production")?u="MASTER":(t.includes("instance_")||t.includes("local"))&&(u="PEER");let f="";if(s&&s.base_url&&!s.base_url.includes("localhost"))try{f=new URL(s.base_url).hostname}catch{}if(!f){let r=t;if(r=r.replace(/^production_/,""),r=r.replace(/^local_/,""),r=r.replace(/^instance_/,""),r.includes("-")){const _=r.split("-");_.length>=5&&(r=_.slice(0,2).join("-"))}r.length>20&&(r=r.substring(0,20)),f=r}return`${u}-${f}`}Oe(()=>{B()}),je();var O=vt(),W=l(O),ne=d(l(W),2),G=l(ne);let oe;var V=d(G,2);let le;var Re=d(V,2);o(ne),o(W);var ie=d(W,2);{var Se=t=>{var n=Ze();let s;var u=l(n),f=l(u,!0);o(u);var r=d(u,2),_=d(r,2),F=l(_);{var J=b=>{var S=Xe();he(3),v(b,S)},a=b=>{var S=Ye();he(2),v(b,S)};k(F,b=>{e(R)==="vip"?b(J):b(a,!1)})}o(_);var U=d(_,2);o(n),T(()=>{s=z(n,1,"qr-panel svelte-ecn2p3",null,s,{vip:e(R)==="vip"}),A(f,e(R)==="vip"?"‚ö° Auto-Approve Pairing":"üîí Standard Pairing"),ye(r,"src",e(j))}),w("click",U,()=>m(x,!1)),v(t,n)};k(ie,t=>{e(x)&&e(j)&&t(Se)})}var ce=d(ie,2),Ne=l(ce);{var Pe=t=>{var n=et();v(t,n)},Ue=t=>{var n=fe(),s=te(n);{var u=r=>{var _=tt();v(r,_)},f=r=>{var _=dt(),F=d(l(_));be(F,5,()=>e(E),ge,(J,a)=>{var U=ct();let b;var S=l(U),Qe=l(S);{var Ee=i=>{var c=at();v(i,c)},Le=i=>{var c=st(),g=l(c,!0);o(c),T(()=>{z(c,1,`badge ${e(a).status??""}`,"svelte-ecn2p3"),A(g,e(a).status)}),v(i,c)};k(Qe,i=>{e(a).deletedAt?i(Ee):i(Le,!1)})}o(S);var X=d(S),de=l(X),qe=l(de,!0);o(de),o(X);var Y=d(X),H=l(Y),Ke=l(H);o(H);var ve=d(H,2),Ce=l(ve,!0);o(ve),o(Y);var Z=d(Y),pe=l(Z),D=l(pe),q=l(D),Te=l(q);o(q);var ue={},ze=d(q);be(ze,1,()=>e(L),ge,(i,c)=>{var g=fe(),K=te(g);{var M=C=>{var N=rt(),y=l(N,!0);o(N);var I={};T($e=>{A(y,$e),I!==(I=e(c).instance_id)&&(N.value=(N.__value=e(c).instance_id)??"")},[()=>re(e(c).instance_id,!0)]),v(C,N)};k(K,C=>{e(c).instance_id!==e(a).homeInstanceId&&C(M)})}v(i,g)}),o(D);var _e;Ve(D),o(pe),o(Z);var ee=d(Z),Be=l(ee,!0);o(ee);var me=d(ee),Fe=l(me);{var He=i=>{var c=nt();w("click",c,()=>xe(e(a).deviceId)),v(i,c)},Me=i=>{var c=it(),g=te(c);{var K=y=>{var I=ot();w("click",I,()=>ae(e(a).deviceId,"active")),v(y,I)};k(g,y=>{(e(a).status==="pending"||e(a).status==="blocked")&&y(K)})}var M=d(g,2);{var C=y=>{var I=lt();w("click",I,()=>ae(e(a).deviceId,"blocked")),v(y,I)};k(M,y=>{(e(a).status==="active"||e(a).status==="pending")&&y(C)})}var N=d(M,2);w("click",N,()=>Ae(e(a).deviceId)),v(i,c)};k(Fe,i=>{e(a).deletedAt?i(He):i(Me,!1)})}o(me),o(U),T((i,c,g,K)=>{b=z(U,1,"svelte-ecn2p3",null,b,{deleted:e(a).deletedAt}),A(qe,e(a).name||"Unknown"),ye(H,"title",e(a).deviceId),A(Ke,`${i??""}...`),A(Ce,c),D.disabled=!!e(a).deletedAt,A(Te,`${g??""} (Current)`),ue!==(ue=e(a).homeInstanceId)&&(q.value=(q.__value=e(a).homeInstanceId)??""),_e!==(_e=e(a).homeInstanceId)&&(D.value=(D.__value=e(a).homeInstanceId)??"",Je(D,e(a).homeInstanceId)),A(Be,K)},[()=>e(a).deviceId.substring(0,8),()=>e(a).publicKey?e(a).publicKey.substring(0,8)+"...":"-",()=>re(e(a).homeInstanceId),()=>new Date(e(a).lastSeenAt).toLocaleString()]),w("change",D,i=>Ie(e(a).deviceId,i.target.value)),v(J,U)}),o(F),o(_),v(r,_)};k(s,r=>{e(E).length===0?r(u):r(f,!1)},!0)}v(t,n)};k(Ne,t=>{e($)?t(Pe):t(Ue,!1)})}o(ce),o(O),T(()=>{oe=z(G,1,"btn secondary svelte-ecn2p3",null,oe,{active:e(x)&&e(R)==="standard"}),le=z(V,1,"btn primary svelte-ecn2p3",null,le,{active:e(x)&&e(R)==="vip"})}),w("click",G,()=>se("standard")),w("click",V,()=>se("vip")),w("click",Re,B),v(ke,O),Ge()}export{It as component};
