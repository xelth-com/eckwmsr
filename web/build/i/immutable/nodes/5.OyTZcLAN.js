import{a as c,f as i,c as pt}from"../chunks/BygaA0WS.js";import{i as ut}from"../chunks/BqIW1Qmb.js";import{z as _t,G as bt,A as F,B as ft,D as n,C as r,F as a,b as e,c as o,m as P,J as M,E as me}from"../chunks/CN5Z31N9.js";import{e as g,s as S}from"../chunks/DAV6nA3v.js";import{i as R}from"../chunks/CU63fefz.js";import{s as z,e as Pe,i as Re}from"../chunks/DFBiLcyC.js";import{r as mt,s as We}from"../chunks/BZk0zrkd.js";import{b as ht}from"../chunks/De01lyDX.js";import{i as gt,s as yt}from"../chunks/DwKrkxP9.js";import{a as x}from"../chunks/Nceboc1J.js";import{t as u}from"../chunks/DycCOpGa.js";import{b as je}from"../chunks/BODtoanW.js";var wt=i('<strong class="svelte-ecn2p3">Warning:</strong> Devices scanning this code will be <u class="svelte-ecn2p3">immediately authorized</u>.',1),kt=i('Devices scanning this code will appear as <strong class="svelte-ecn2p3">Pending</strong> below.',1),It=i('<div><h3 class="svelte-ecn2p3"> </h3> <img alt="Pairing QR" class="svelte-ecn2p3"/> <p class="hint svelte-ecn2p3"><!></p> <button class="btn-text svelte-ecn2p3">Close</button></div>'),Dt=i('<div class="loading svelte-ecn2p3">Loading devices...</div>'),St=i('<div class="empty svelte-ecn2p3">No devices registered. Scan a QR code to add one.</div>'),xt=i('<span class="badge deleted svelte-ecn2p3">Deleted</span>'),At=i("<span> </span>"),Nt=i('<option class="svelte-ecn2p3"> </option>'),Pt=i('<button class="btn-icon svelte-ecn2p3" title="Restore">&#9851;</button>'),Rt=i('<button class="btn-icon approve svelte-ecn2p3" title="Approve">&#10003;</button>'),Ct=i('<button class="btn-icon block svelte-ecn2p3" title="Block">&#10007;</button>'),Ut=i('<!> <!> <button class="btn-icon delete svelte-ecn2p3" title="Delete">&#128465;</button>',1),Tt=i('<tr><td class="svelte-ecn2p3"><!></td><td class="svelte-ecn2p3"> </td><td class="svelte-ecn2p3"><div class="mono-id svelte-ecn2p3"> </div> <div class="mono-key svelte-ecn2p3"> </div></td><td class="svelte-ecn2p3"><select class="node-select svelte-ecn2p3"><option class="svelte-ecn2p3"> </option><!></select></td><td class="svelte-ecn2p3"> </td><td class="actions svelte-ecn2p3"><!></td></tr>'),qt=i('<table class="svelte-ecn2p3"><thead class="svelte-ecn2p3"><tr class="svelte-ecn2p3"><th class="svelte-ecn2p3">Status</th><th class="svelte-ecn2p3">Device Name</th><th class="svelte-ecn2p3">ID / Key</th><th class="svelte-ecn2p3">Home Node</th><th class="svelte-ecn2p3">Last Seen</th><th class="svelte-ecn2p3">Actions</th></tr></thead><tbody class="svelte-ecn2p3"></tbody></table>'),Ft=i('<div class="toolbar svelte-ecn2p3"><div class="action-group svelte-ecn2p3"><button>Standard QR</button> <button>Auto-Approve QR</button></div> <button class="btn secondary svelte-ecn2p3">Refresh</button></div> <!> <div class="list-container svelte-ecn2p3"><!></div>',1),Lt=i('<h3 class="svelte-ecn2p3">Waiting for connection...</h3> <div class="big-code svelte-ecn2p3"> </div> <p class="svelte-ecn2p3">Enter this code on the other server</p> <div class="spinner svelte-ecn2p3"></div> <button class="btn secondary svelte-ecn2p3">Cancel</button>',1),Qt=i('<h3 class="svelte-ecn2p3">Connection Request</h3> <p class="svelte-ecn2p3">Server <strong class="svelte-ecn2p3"> </strong> wants to connect.</p> <p class="mono-sm svelte-ecn2p3"> </p> <div class="modal-actions svelte-ecn2p3"><button class="btn secondary svelte-ecn2p3">Deny</button> <button class="btn primary svelte-ecn2p3">Approve</button></div>',1),Xt=i('<h3 class="svelte-ecn2p3">Connecting...</h3> <div class="spinner svelte-ecn2p3"></div>',1),zt=i('<h3 class="svelte-ecn2p3">Waiting for approval...</h3> <p class="svelte-ecn2p3">Please approve the request on the Host server.</p> <div class="spinner svelte-ecn2p3"></div> <button class="btn secondary svelte-ecn2p3">Cancel</button>',1),Ht=i('<div class="pairing-modal svelte-ecn2p3"><div class="modal-content svelte-ecn2p3"><!></div></div>'),Et=i('<div class="loading svelte-ecn2p3">Loading nodes...</div>'),Kt=i('<div class="empty svelte-ecn2p3">No paired servers. Use "Invite Server" or enter a code to join a network.</div>'),Ot=i('<tr class="svelte-ecn2p3"><td class="svelte-ecn2p3"><span></span> </td><td class="svelte-ecn2p3"> </td><td class="svelte-ecn2p3"><span> </span></td><td class="mono svelte-ecn2p3"> </td><td class="svelte-ecn2p3"><button class="btn-icon delete svelte-ecn2p3" title="Unpair">&#128465;</button></td></tr>'),Wt=i('<table class="svelte-ecn2p3"><thead class="svelte-ecn2p3"><tr class="svelte-ecn2p3"><th class="svelte-ecn2p3">Status</th><th class="svelte-ecn2p3">Name</th><th class="svelte-ecn2p3">Role</th><th class="svelte-ecn2p3">Address</th><th class="svelte-ecn2p3">Actions</th></tr></thead><tbody class="svelte-ecn2p3"></tbody></table>'),jt=i('<div class="toolbar svelte-ecn2p3"><div class="action-group svelte-ecn2p3"><button class="btn primary svelte-ecn2p3">+ Invite Server</button></div> <div class="join-group svelte-ecn2p3"><input type="text" placeholder="XXX-XXX" maxlength="7" class="svelte-ecn2p3"/> <button class="btn secondary svelte-ecn2p3">Join Network</button></div></div> <!> <div class="list-container svelte-ecn2p3"><!></div>',1),Bt=i('<div class="page svelte-ecn2p3"><header class="svelte-ecn2p3"><h1 class="svelte-ecn2p3">Connectivity & Devices</h1> <div class="tabs svelte-ecn2p3"><button>Scanners (PDAs)</button> <button>Mesh Servers</button></div></header> <!></div>');function ra(Be,Je){_t(Je,!1);let ce=P("scanners"),ee=P([]),he=P([]),G=P(!0),ge=P(""),K=P(!1),O=P("standard"),I=P("idle"),ie=P(""),W=P(""),te=P(null),ve=null;async function ae(){o(G,!0);try{const[t,s,v]=await Promise.all([x.get("/api/admin/devices?include_deleted=true"),x.get("/mesh/nodes"),x.get("/mesh/status")]);o(ee,t||[]);let f=s||[];v&&v.instance_id&&(f=[{instance_id:v.instance_id,role:v.role||"peer",base_url:v.base_url||"http://localhost:3210",is_self:!0},...f]),o(he,f)}catch(t){u.add("Failed to load devices: "+t.message,"error")}finally{o(G,!1)}}async function Ce(t,s){try{await x.put(`/api/admin/devices/${t}/status`,{status:s}),u.add(`Device ${s}`,"success"),o(ee,e(ee).map(v=>v.deviceId===t?{...v,status:s}:v))}catch(v){u.add(v.message,"error")}}async function Me(t,s){try{await x.put(`/api/admin/devices/${t}/home`,{homeInstanceId:s}),u.add("Home Node updated","success")}catch(v){u.add(v.message,"error")}}async function Ge(t){if(confirm("Delete this device?"))try{await x.delete(`/api/admin/devices/${t}`),u.add("Device deleted","success"),await ae()}catch(s){u.add(s.message,"error")}}async function Ve(t){try{await x.post(`/api/admin/devices/${t}/restore`),u.add("Device restored","success"),await ae()}catch(s){u.add(s.message,"error")}}async function Ue(t="standard"){if(e(K)&&e(O)===t){o(K,!1);return}o(O,t);try{const s=localStorage.getItem("auth_token"),v=t==="vip"?`${je}/api/internal/pairing-qr?type=vip`:`${je}/api/internal/pairing-qr`,C=await(await fetch(v,{headers:{Authorization:`Bearer ${s}`}})).blob();o(ge,URL.createObjectURL(C)),o(K,!0)}catch{u.add("Failed to load QR","error")}}function Te(t){if(!t)return"Unknown";const s=e(he).find(C=>C.instance_id===t);let v=s?s.role.toUpperCase():"PEER",f=t;if(s&&s.base_url&&!s.base_url.includes("localhost"))try{f=new URL(s.base_url).hostname}catch{}return f.length>20&&(f=f.substring(0,20)),`${v}-${f}`}let ye=P([]);async function de(){o(G,!0);try{const t=await x.get("/mesh/nodes");o(ye,t||[])}catch{u.add("Failed to load nodes","error")}finally{o(G,!1)}}async function Ye(t){if(confirm("Unpair this server?"))try{await x.delete(`/api/admin/mesh/${t}`),u.add("Server unpaired","success"),await de()}catch(s){u.add(s.message,"error")}}async function Ze(){try{const t=await x.post("/api/pairing/host",{});o(ie,t.code),o(I,"hosting"),qe(t.code)}catch(t){u.add(t.message,"error")}}async function qe(t){if(e(I)==="hosting")try{const s=await x.post("/api/pairing/check",{code:t});s.found?(o(te,{id:s.remote_instance_id,name:s.remote_instance_name}),o(I,"approving")):ve=setTimeout(()=>qe(t),2e3)}catch(s){console.error("Polling error",s)}}async function $e(){try{await x.post("/api/pairing/approve",{code:e(ie),remote_instance_id:e(te).id}),u.add("Pairing successful!","success"),o(I,"idle"),de()}catch(t){u.add(t.message,"error")}}async function et(){if(e(W))try{o(I,"connecting"),await x.post("/api/pairing/connect",{code:e(W)}),u.add("Connected! Waiting for approval...","info"),o(I,"waiting_approval"),Fe(e(W))}catch(t){o(I,"idle"),u.add(t.message,"error")}}async function Fe(t){if(e(I)==="waiting_approval")try{const s=await x.post("/api/pairing/finalize",{code:t});s.status==="finalized"?(s.network_key&&await tt(s.network_key),u.add("Pairing Complete! Server saved.","success"),o(I,"idle"),de()):ve=setTimeout(()=>Fe(t),2e3)}catch(s){console.error(s)}}async function tt(t){try{await x.post("/api/admin/config/save-key",{network_key:t}),u.add("Network Key saved. Restart server to apply.","warning")}catch(s){u.add("Failed to save config: "+s.message,"error")}}function we(){ve&&clearTimeout(ve),o(I,"idle"),o(ie,""),o(W,""),o(te,null)}function Le(t){o(ce,t),t==="scanners"?ae():de()}bt(()=>{ae()}),ut();var ke=Bt(),Ie=n(ke),Qe=r(n(Ie),2),De=n(Qe);let Xe;var ze=r(De,2);let He;a(Qe),a(Ie);var at=r(Ie,2);{var st=t=>{var s=Ft(),v=M(s),f=n(v),C=n(f);let se;var V=r(C,2);let ne;a(f);var pe=r(f,2);a(v);var ue=r(v,2);{var _e=d=>{var m=It();let L;var D=n(m),l=n(D,!0);a(D);var A=r(D,2),U=r(A,2),p=n(U);{var k=h=>{var N=wt();me(3),c(h,N)},w=h=>{var N=kt();me(2),c(h,N)};R(p,h=>{e(O)==="vip"?h(k):h(w,!1)})}a(U);var q=r(U,2);a(m),F(()=>{L=z(m,1,"qr-panel svelte-ecn2p3",null,L,{vip:e(O)==="vip"}),S(l,e(O)==="vip"?"Auto-Approve Pairing":"Standard Pairing"),We(A,"src",e(ge))}),g("click",q,()=>o(K,!1)),c(d,m)};R(ue,d=>{e(K)&&e(ge)&&d(_e)})}var be=r(ue,2),Se=n(be);{var xe=d=>{var m=Dt();c(d,m)},Ae=d=>{var m=St();c(d,m)},y=d=>{var m=qt(),L=r(n(m));Pe(L,5,()=>e(ee),Re,(D,l)=>{var A=Tt();let U;var p=n(A),k=n(p);{var w=_=>{var b=xt();c(_,b)},q=_=>{var b=At(),Q=n(b,!0);a(b),F(()=>{z(b,1,`badge ${e(l).status??""}`,"svelte-ecn2p3"),S(Q,e(l).status)}),c(_,b)};R(k,_=>{e(l).deletedAt?_(w):_(q,!1)})}a(p);var h=r(p),N=n(h,!0);a(h);var j=r(h),T=n(j),Y=n(T);a(T);var B=r(T,2),Z=n(B,!0);a(B),a(j);var $=r(j),H=n($),re=n(H),rt=n(re);a(re);var Ee={},lt=r(re);Pe(lt,1,()=>e(he),Re,(_,b)=>{var Q=pt(),le=M(Q);{var fe=oe=>{var J=Nt(),X=n(J,!0);a(J);var E={};F(dt=>{S(X,dt),E!==(E=e(b).instance_id)&&(J.value=(J.__value=e(b).instance_id)??"")},[()=>Te(e(b).instance_id)]),c(oe,J)};R(le,oe=>{e(b).instance_id!==e(l).homeInstanceId&&oe(fe)})}c(_,Q)}),a(H);var Ke;gt(H),a($);var Ne=r($),ot=n(Ne,!0);a(Ne);var Oe=r(Ne),ct=n(Oe);{var it=_=>{var b=Pt();g("click",b,()=>Ve(e(l).deviceId)),c(_,b)},vt=_=>{var b=Ut(),Q=M(b);{var le=X=>{var E=Rt();g("click",E,()=>Ce(e(l).deviceId,"active")),c(X,E)};R(Q,X=>{(e(l).status==="pending"||e(l).status==="blocked")&&X(le)})}var fe=r(Q,2);{var oe=X=>{var E=Ct();g("click",E,()=>Ce(e(l).deviceId,"blocked")),c(X,E)};R(fe,X=>{(e(l).status==="active"||e(l).status==="pending")&&X(oe)})}var J=r(fe,2);g("click",J,()=>Ge(e(l).deviceId)),c(_,b)};R(ct,_=>{e(l).deletedAt?_(it):_(vt,!1)})}a(Oe),a(A),F((_,b,Q,le)=>{U=z(A,1,"svelte-ecn2p3",null,U,{deleted:e(l).deletedAt}),S(N,e(l).name||"Unknown"),We(T,"title",e(l).deviceId),S(Y,`${_??""}...`),S(Z,b),H.disabled=!!e(l).deletedAt,S(rt,`${Q??""} (Current)`),Ee!==(Ee=e(l).homeInstanceId)&&(re.value=(re.__value=e(l).homeInstanceId)??""),Ke!==(Ke=e(l).homeInstanceId)&&(H.value=(H.__value=e(l).homeInstanceId)??"",yt(H,e(l).homeInstanceId)),S(ot,le)},[()=>e(l).deviceId.substring(0,8),()=>e(l).publicKey?e(l).publicKey.substring(0,8)+"...":"-",()=>Te(e(l).homeInstanceId),()=>new Date(e(l).lastSeenAt).toLocaleString()]),g("change",H,_=>Me(e(l).deviceId,_.target.value)),c(D,A)}),a(L),a(m),c(d,m)};R(Se,d=>{e(G)?d(xe):e(ee).length===0?d(Ae,1):d(y,!1)})}a(be),F(()=>{se=z(C,1,"btn secondary svelte-ecn2p3",null,se,{active:e(K)&&e(O)==="standard"}),ne=z(V,1,"btn primary svelte-ecn2p3",null,ne,{active:e(K)&&e(O)==="vip"})}),g("click",C,()=>Ue("standard")),g("click",V,()=>Ue("vip")),g("click",pe,ae),c(t,s)},nt=t=>{var s=jt(),v=M(s),f=n(v),C=n(f);a(f);var se=r(f,2),V=n(se);mt(V);var ne=r(V,2);a(se),a(v);var pe=r(v,2);{var ue=y=>{var d=Ht(),m=n(d),L=n(m);{var D=p=>{var k=Lt(),w=r(M(k),2),q=n(w,!0);a(w);var h=r(w,6);F(()=>S(q,e(ie))),g("click",h,we),c(p,k)},l=p=>{var k=Qt(),w=r(M(k),2),q=r(n(w)),h=n(q,!0);a(q),me(),a(w);var N=r(w,2),j=n(N);a(N);var T=r(N,2),Y=n(T),B=r(Y,2);a(T),F(()=>{var Z,$;S(h,((Z=e(te))==null?void 0:Z.name)||"Unknown"),S(j,`ID: ${(($=e(te))==null?void 0:$.id)??""}`)}),g("click",Y,we),g("click",B,$e),c(p,k)},A=p=>{var k=Xt();me(2),c(p,k)},U=p=>{var k=zt(),w=r(M(k),6);g("click",w,we),c(p,k)};R(L,p=>{e(I)==="hosting"?p(D):e(I)==="approving"?p(l,1):e(I)==="connecting"?p(A,2):e(I)==="waiting_approval"&&p(U,3)})}a(m),a(d),c(y,d)};R(pe,y=>{e(I)!=="idle"&&y(ue)})}var _e=r(pe,2),be=n(_e);{var Se=y=>{var d=Et();c(y,d)},xe=y=>{var d=Kt();c(y,d)},Ae=y=>{var d=Wt(),m=r(n(d));Pe(m,5,()=>e(ye),Re,(L,D)=>{var l=Ot(),A=n(l),U=n(A);let p;var k=r(U);a(A);var w=r(A),q=n(w,!0);a(w);var h=r(w),N=n(h),j=n(N,!0);a(N),a(h);var T=r(h),Y=n(T,!0);a(T);var B=r(T),Z=n(B);a(B),a(l),F(()=>{p=z(U,1,"dot svelte-ecn2p3",null,p,{online:e(D).is_online}),S(k,` ${e(D).is_online?"Online":"Offline"}`),S(q,e(D).name),z(N,1,`role-badge ${e(D).role??""}`,"svelte-ecn2p3"),S(j,e(D).role),S(Y,e(D).base_url||"Relay Only")}),g("click",Z,()=>Ye(e(D).instance_id)),c(L,l)}),a(m),a(d),c(y,d)};R(be,y=>{e(G)?y(Se):e(ye).length===0?y(xe,1):y(Ae,!1)})}a(_e),F(()=>ne.disabled=e(W).length<6),g("click",C,Ze),ht(V,()=>e(W),y=>o(W,y)),g("click",ne,et),c(t,s)};R(at,t=>{e(ce)==="scanners"?t(st):t(nt,!1)})}a(ke),F(()=>{Xe=z(De,1,"tab svelte-ecn2p3",null,Xe,{active:e(ce)==="scanners"}),He=z(ze,1,"tab svelte-ecn2p3",null,He,{active:e(ce)==="servers"})}),g("click",De,()=>Le("scanners")),g("click",ze,()=>Le("servers")),c(Be,ke),ft()}export{ra as component};
