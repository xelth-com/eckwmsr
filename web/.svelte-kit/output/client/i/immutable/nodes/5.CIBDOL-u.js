import{a as v,f as p,c as Be}from"../chunks/CVSPybqJ.js";import{i as Fe}from"../chunks/BdqhJSGs.js";import{z as He,G as Me,A as C,B as $e,D as l,C as d,F as o,b as e,c as _,m as P,J as ue,E as _e}from"../chunks/CqpwgXEk.js";import{e as y,s as D}from"../chunks/D0Wkj3YL.js";import{i as I}from"../chunks/NgGcbYIQ.js";import{s as T,e as me,i as fe}from"../chunks/DKR_uuIj.js";import{s as he}from"../chunks/CO09g7J9.js";import{i as je,s as Oe}from"../chunks/CRyKHIxi.js";import{a as S}from"../chunks/dVpO60LJ.js";import{t as f}from"../chunks/C3Rs9I5p.js";import{b as be}from"../chunks/CQ3cvpm9.js";var We=p("<strong>Warning:</strong> Devices scanning this code will be <u>immediately authorized</u>. Valid for 24 hours.",1),Ge=p("Devices scanning this code will appear as <strong>Pending</strong> below.",1),Je=p('<div><h3> </h3> <img alt="Pairing QR" class="svelte-ecn2p3"/> <p class="hint svelte-ecn2p3"><!></p> <button class="btn-text svelte-ecn2p3">Close</button></div>'),Ve=p('<div class="loading svelte-ecn2p3">Loading devices...</div>'),Xe=p('<div class="empty svelte-ecn2p3">No devices registered. Scan a QR code to add one.</div>'),Ye=p('<span class="badge deleted svelte-ecn2p3">Deleted</span>'),Ze=p("<span> </span>"),et=p("<option> </option>"),tt=p('<button class="btn-icon restore svelte-ecn2p3" title="Restore">‚ôªÔ∏è</button>'),at=p('<button class="btn-icon approve svelte-ecn2p3" title="Approve">‚úÖ</button>'),st=p('<button class="btn-icon block svelte-ecn2p3" title="Block">‚õî</button>'),rt=p('<!> <!> <button class="btn-icon delete svelte-ecn2p3" title="Delete">üóëÔ∏è</button>',1),nt=p('<tr><td class="svelte-ecn2p3"><!></td><td class="svelte-ecn2p3"><div class="device-name"> </div></td><td class="svelte-ecn2p3"><div class="mono-id svelte-ecn2p3"> </div> <div class="mono-key svelte-ecn2p3" title="Public Key"> </div></td><td class="svelte-ecn2p3"><div class="home-node-control svelte-ecn2p3"><select class="svelte-ecn2p3"><option> </option><!></select></div></td><td class="svelte-ecn2p3"> </td><td class="actions svelte-ecn2p3"><!></td></tr>'),ot=p('<table class="svelte-ecn2p3"><thead><tr><th class="svelte-ecn2p3">Status</th><th class="svelte-ecn2p3">Device Name</th><th class="svelte-ecn2p3">ID / Key</th><th class="svelte-ecn2p3">Home Node (Proxy Target)</th><th class="svelte-ecn2p3">Last Seen</th><th class="svelte-ecn2p3">Actions</th></tr></thead><tbody></tbody></table>'),lt=p('<div class="page"><header class="svelte-ecn2p3"><h1 class="svelte-ecn2p3">Device Management</h1> <div class="action-group svelte-ecn2p3"><button>Show Standard QR</button> <button>Show Auto-Approve QR</button> <button class="btn secondary svelte-ecn2p3">‚Üª Refresh</button></div></header> <!> <div class="device-list"><!></div></div>');function gt(ge,ye){He(ye,!1);let U=P([]),Q=P([]),H=P(!0),M=P(""),A=P(!1),x=P("standard");async function z(){_(H,!0);try{const[t,s,r]=await Promise.all([S.get("/api/admin/devices?include_deleted=true"),S.get("/mesh/nodes"),S.get("/mesh/status")]);if(_(U,t||[]),_(Q,s||[]),r&&r.instance_id){const u={instance_id:r.instance_id,role:r.role||"peer",base_url:r.base_url||"http://localhost:3210",is_self:!0};_(Q,[u,...e(Q)])}}catch(t){f.add("Failed to load data: "+t.message,"error")}finally{_(H,!1)}}async function ee(t,s){try{await S.put(`/api/admin/devices/${t}/status`,{status:s}),f.add(`Device ${s}`,"success"),_(U,e(U).map(r=>r.deviceId===t?{...r,status:s}:r))}catch(r){f.add(r.message,"error")}}async function we(t,s){try{await S.put(`/api/admin/devices/${t}/home`,{homeInstanceId:s}),f.add("Home Node updated","success")}catch(r){f.add(r.message,"error")}}async function ke(t){if(confirm("Are you sure you want to delete this device? This will sync to all nodes."))try{await S.delete(`/api/admin/devices/${t}`),f.add("Device deleted","success"),await z()}catch(s){f.add(s.message,"error")}}async function De(t){try{await S.post(`/api/admin/devices/${t}/restore`),f.add("Device restored","success"),await z()}catch(s){f.add(s.message,"error")}}async function te(t="standard"){if(e(A)&&e(x)===t){_(A,!1);return}_(x,t);try{const s=localStorage.getItem("auth_token"),r=t==="vip"?`${be}/api/internal/pairing-qr?type=vip`:`${be}/api/internal/pairing-qr`,a=await(await fetch(r,{headers:{Authorization:`Bearer ${s}`}})).blob();_(M,URL.createObjectURL(a)),_(A,!0)}catch{f.add("Failed to load Pairing QR","error")}}function ae(t,s=!1){if(!t)return"Unknown";const r=e(Q).find(n=>n.instance_id===t);let u="UNKNOWN";r?u=r.role.toUpperCase():t.includes("production")?u="MASTER":(t.includes("instance_")||t.includes("local"))&&(u="PEER");let a="";if(r&&r.base_url&&!r.base_url.includes("localhost"))try{a=new URL(r.base_url).hostname}catch{}if(!a){let n=t;if(n=n.replace(/^production_/,""),n=n.replace(/^local_/,""),n=n.replace(/^instance_/,""),n.includes("-")){const h=n.split("-");h.length>=5&&(n=h.slice(0,2).join("-"))}n.length>20&&(n=n.substring(0,20)),a=n}return`${u}-${a}`}Me(()=>{z()}),Fe();var $=lt(),j=l($),se=d(l(j),2),O=l(se);let re;var W=d(O,2);let ne;var Ie=d(W,2);o(se),o(j);var oe=d(j,2);{var Ae=t=>{var s=Je();let r;var u=l(s),a=l(u,!0);o(u);var n=d(u,2),h=d(n,2),E=l(h);{var G=m=>{var N=We();_e(3),v(m,N)},J=m=>{var N=Ge();_e(2),v(m,N)};I(E,m=>{e(x)==="vip"?m(G):m(J,!1)})}o(h);var V=d(h,2);o(s),C(()=>{r=T(s,1,"qr-panel svelte-ecn2p3",null,r,{vip:e(x)==="vip"}),D(a,e(x)==="vip"?"‚ö° Auto-Approve Pairing":"üîí Standard Pairing"),he(n,"src",e(M))}),y("click",V,()=>_(A,!1)),v(t,s)};I(oe,t=>{e(A)&&e(M)&&t(Ae)})}var le=d(oe,2),xe=l(le);{var Re=t=>{var s=Ve();v(t,s)},Se=t=>{var s=Xe();v(t,s)},Ne=t=>{var s=ot(),r=d(l(s));me(r,5,()=>e(U),fe,(u,a)=>{var n=nt();let h;var E=l(n),G=l(E);{var J=i=>{var c=Ye();v(i,c)},V=i=>{var c=Ze(),b=l(c,!0);o(c),C(()=>{T(c,1,`badge ${e(a).status??""}`,"svelte-ecn2p3"),D(b,e(a).status)}),v(i,c)};I(G,i=>{e(a).deletedAt?i(J):i(V,!1)})}o(E);var m=d(E),N=l(m),Pe=l(N,!0);o(N),o(m);var X=d(m),B=l(X),Ue=l(B);o(B);var ie=d(B,2),Qe=l(ie,!0);o(ie),o(X);var Y=d(X),ce=l(Y),w=l(ce),L=l(w),Ee=l(L);o(L);var de={},Le=d(L);me(Le,1,()=>e(Q),fe,(i,c)=>{var b=Be(),q=ue(b);{var F=K=>{var R=et(),g=l(R,!0);o(R);var k={};C(ze=>{D(g,ze),k!==(k=e(c).instance_id)&&(R.value=(R.__value=e(c).instance_id)??"")},[()=>ae(e(c).instance_id,!0)]),v(K,R)};I(q,K=>{e(c).instance_id!==e(a).homeInstanceId&&K(F)})}v(i,b)}),o(w);var ve;je(w),o(ce),o(Y);var Z=d(Y),qe=l(Z,!0);o(Z);var pe=d(Z),Ke=l(pe);{var Ce=i=>{var c=tt();y("click",c,()=>De(e(a).deviceId)),v(i,c)},Te=i=>{var c=rt(),b=ue(c);{var q=g=>{var k=at();y("click",k,()=>ee(e(a).deviceId,"active")),v(g,k)};I(b,g=>{(e(a).status==="pending"||e(a).status==="blocked")&&g(q)})}var F=d(b,2);{var K=g=>{var k=st();y("click",k,()=>ee(e(a).deviceId,"blocked")),v(g,k)};I(F,g=>{(e(a).status==="active"||e(a).status==="pending")&&g(K)})}var R=d(F,2);y("click",R,()=>ke(e(a).deviceId)),v(i,c)};I(Ke,i=>{e(a).deletedAt?i(Ce):i(Te,!1)})}o(pe),o(n),C((i,c,b,q)=>{h=T(n,1,"svelte-ecn2p3",null,h,{deleted:e(a).deletedAt}),D(Pe,e(a).name||"Unknown"),he(B,"title",e(a).deviceId),D(Ue,`${i??""}...`),D(Qe,c),w.disabled=!!e(a).deletedAt,D(Ee,`${b??""} (Current)`),de!==(de=e(a).homeInstanceId)&&(L.value=(L.__value=e(a).homeInstanceId)??""),ve!==(ve=e(a).homeInstanceId)&&(w.value=(w.__value=e(a).homeInstanceId)??"",Oe(w,e(a).homeInstanceId)),D(qe,q)},[()=>e(a).deviceId.substring(0,8),()=>e(a).publicKey?e(a).publicKey.substring(0,8)+"...":"-",()=>ae(e(a).homeInstanceId),()=>new Date(e(a).lastSeenAt).toLocaleString()]),y("change",w,i=>we(e(a).deviceId,i.target.value)),v(u,n)}),o(r),o(s),v(t,s)};I(xe,t=>{e(H)?t(Re):e(U).length===0?t(Se,1):t(Ne,!1)})}o(le),o($),C(()=>{re=T(O,1,"btn secondary svelte-ecn2p3",null,re,{active:e(A)&&e(x)==="standard"}),ne=T(W,1,"btn primary svelte-ecn2p3",null,ne,{active:e(A)&&e(x)==="vip"})}),y("click",O,()=>te("standard")),y("click",W,()=>te("vip")),y("click",Ie,z),v(ge,$),$e()}export{gt as component};
